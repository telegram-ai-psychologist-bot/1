// === ðŸ“¦ GÐ¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Node.js Telegram AI Webhook Ð±Ð¾Ñ‚ ===

const express = require('express');
const bodyParser = require('body-parser');
const fetch = require('node-fetch');

const app = express();
app.use(bodyParser.json());

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || 'YOUR_TELEGRAM_BOT_TOKEN';
const OPENAI_API_KEY = process.env.OPENAI_API_KEY || 'YOUR_OPENAI_API_KEY';
const TELEGRAM_API = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}`;

// === AI-Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ ===
const INSTRUCTIONS = `Ð¢Ñ‹ â€” Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹ Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ñ‡Ð°ÑÑ‚Ð½Ð¾Ð³Ð¾ Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ð°. Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” ÑÐ¾Ð¿Ñ€Ð¾Ð²Ð¾Ð¶Ð´Ð°Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¾Ñ‚ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Â«Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚ÐµÂ» Ð´Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½Ð° ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸ÑŽ Ð¸Ð»Ð¸ ÐºÑƒÑ€Ñ. ÐžÐ±Ñ‰Ð°Ð¹ÑÑ Ð¼ÑÐ³ÐºÐ¾, ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾, Ð±ÐµÐ· Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ñ.

ðŸ”¹ Ð›Ð¾Ð³Ð¸ÐºÐ° Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:

1. Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð½Ð°Ð¿Ð¸ÑÐ°Ð» Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Â«Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚ÐµÂ» Ð¸Ð»Ð¸ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ð¾Ðµ Ð¿ÐµÑ€Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:
   â€” ÐžÑ‚Ð²ÐµÑ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¸ Ñ‚ÐµÐ¿Ð»Ð¾:
     Â«Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ. Ð•ÑÐ»Ð¸ Ð²Ð°Ð¼ ÑÐµÐ¹Ñ‡Ð°Ñ Ð²Ð°Ð¶Ð½Ð¾ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ Ð² ÑÐµÐ±Ðµ â€” Ñ Ñ€ÑÐ´Ð¾Ð¼. ÐœÐ¾Ð³Ñƒ Ñ€Ð°ÑÑÐºÐ°Ð·Ð°Ñ‚ÑŒ, ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð¿ÐµÑ€Ð²Ð°Ñ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð°. ÐžÑ€Ð¸ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÑŽÑÑŒ Ð½Ð° Ð²Ð°Ñ.Â»

2. Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÐµÑ‚ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ Ð¸Ð»Ð¸ Ð·Ð°Ð´Ð°Ñ‘Ñ‚ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹:
   â€” Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ð¿Ñ€Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹: Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ñ, Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°, ÐºÑƒÑ€Ñ Ð¸Ð· 5 Ð¸Ð»Ð¸ 10 Ð²ÑÑ‚Ñ€ÐµÑ‡.
   â€” Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸, Ñ‡Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð±Ð»Ð¸Ð¶Ðµ Ð¸Ð¼ÐµÐ½Ð½Ð¾ ÐµÐ¼Ñƒ.

3. Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð³Ð¾Ñ‚Ð¾Ð² â€” Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹:
   â€” Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°: 8(978)760-26-21 (Ð¢-Ð‘Ð°Ð½Ðº)
   â€” Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ ÐºÐ°Ñ€Ñ‚Ñ‹: 5536 9138 3548 3914
   â€” Ñ‡ÐµÑ€ÐµÐ· QR (Ð±Ð¾Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸)

4. ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ â€” ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸, ÐºÐ°ÐºÐ¸Ðµ Ð´Ð½Ð¸ Ð¸ Ð²Ñ€ÐµÐ¼Ñ ÑƒÐ´Ð¾Ð±Ð½Ñ‹, Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ðµ:
   â€” Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðºâ€“Ð¿ÑÑ‚Ð½Ð¸Ñ†Ð°, 10:00 / 12:00 / 14:00

5. Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ¾Ð¼Ð½ÐµÐ²Ð°ÐµÑ‚ÑÑ Ð¸Ð»Ð¸ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Â«Ð½Ðµ Ð·Ð½Ð°ÑŽÂ»:
   â€” ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸, Ð±ÐµÐ· Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ñ: Â«Ð­Ñ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾. Ð˜Ð½Ð¾Ð³Ð´Ð° Ð²Ð°Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ñ€Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð²ÑÐ»ÑƒÑ…, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÑ‚Ð°Ð»Ð¾ Ñ‡ÑƒÑ‚ÑŒ ÑÑÐ½ÐµÐµ. Ð•ÑÐ»Ð¸ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ â€” Ð¼Ð¾Ð¶ÐµÐ¼ ÑÐ¾Ð·Ð²Ð¾Ð½Ð¸Ñ‚ÑŒÑÑ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð±ÐµÐ· Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÑÑ‚Ð².Â»

6. Ð’ ÐºÐ¾Ð½Ñ†Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð° **Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ ÑÑ‚Ñ€Ð¾ÐºÑƒ**:
   Ð¦ÐµÐ»ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: ...

ðŸ”¸ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ñ†ÐµÐ»ÐµÐ¹:
- Ð¥Ð¾Ñ‡ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÑƒ
- Ð¥Ð¾Ñ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸ ÐºÑƒÑ€Ñ Ð¸Ð· 5 ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¹
- Ð¡Ð¾Ð¼Ð½ÐµÐ²Ð°ÐµÑ‚ÑÑ, Ð½Ð¾ Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÐµÑ‚ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ
- ÐŸÐ¾ÐºÐ° Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚ÑÑ / Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²
`;

// === ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Telegram ===
async function sendTelegramMessage(chatId, text) {
  await fetch(`${TELEGRAM_API}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: chatId, text })
  });
}

// === ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚ ChatGPT ===
async function getAIResponse(userMessage) {
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: 'gpt-4',
      messages: [
        { role: 'system', content: INSTRUCTIONS },
        { role: 'user', content: userMessage }
      ]
    })
  });
  const data = await res.json();
  return data.choices?.[0]?.message?.content || 'Ð§Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº...';
}

// === ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Webhook Ð¾Ñ‚ Telegram ===
app.post('/webhook', async (req, res) => {
  const message = req.body?.message;
  if (!message) return res.sendStatus(200);

  const chatId = message.chat.id;
  const userMessage = message.text;

  try {
    const reply = await getAIResponse(userMessage);
    await sendTelegramMessage(chatId, reply);
  } catch (err) {
    console.error(err);
    await sendTelegramMessage(chatId, 'ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°.');
  }

  res.sendStatus(200);
});

// === Ð”Ð»Ñ Render Ð¸Ð»Ð¸ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° ===
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Bot running on port ${PORT}`);
});
